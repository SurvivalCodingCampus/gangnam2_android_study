name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 1. 유닛 테스트 실행
      - name: Run Unit Tests
        run: ./gradlew test --no-daemon

      # 2. 린트 검사 실행
      # 빌드(Assemble) 전에 코드 상의 잠재적 버그나 스타일을 체크합니다.
      - name: Run Lint Check
        run: ./gradlew lintDevDebug --no-daemon

      # 3. 빌드 실행 (Assemble)
      - name: Build with Gradle
        run: >
          ./gradlew assembleDevDebug 
          --no-daemon 
          --max-workers=2 
          -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"

      # 4. 결과 보고서 업로드 (테스트 결과 + 린트 결과)
      - name: Upload Reports
        if: always() # 빌드가 실패하더라도 리포트는 확인할 수 있도록 설정
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            **/build/reports/tests/
            **/build/reports/lint-results*.html
            **/build/reports/lint-results*.xml
      # 5. 디스코드 알림 단계 추가
      - name: Discord notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "Android CI Build Status"
          description: |
            **Result:** ${{ job.status }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.event.head_commit.message }}