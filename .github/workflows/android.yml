name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 1. 유닛 테스트 실행
    # 테스트 단계에서도 메모리 부족이 날 수 있으므로 --no-daemon을 권장합니다.
    - name: Run Unit Tests
      run: ./gradlew test --no-daemon

    # 2. 빌드 실행 (Assemble)
    # 모든 Flavor를 빌드하는 assembleDebug 대신 Dev 타겟 하나만 빌드하여 메모리 점유를 줄입니다.
    # JVM 힙 메모리를 4GB로 제한하고 병렬 빌드를 제한하는 옵션을 추가했습니다.
    - name: Build with Gradle
      run: >
        ./gradlew assembleDevDebug 
        --no-daemon 
        --max-workers=2 
        -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"

    # 3. 테스트 결과 업로드
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: '**/build/reports/tests/'
